MERGE `boeing-dev-bcdap-scrr.SCRR.DER_IRR_REPORT` AS T
USING (SELECT * FROM SOURCE_DATA) AS S
ON T.SUPPLIER_BEST_CODE = S.SUPPLIER_BEST_CODE

WHEN MATCHED AND T.DATA_HASH != S.DATA_HASH THEN
  UPDATE SET
    T.DUNSNUMBER = S.DUNSNUMBER,
    T.GLOBAL_ULTIMATE_DUNS_NUMBER = S.GLOBAL_ULTIMATE_DUNS_NUMBER,
    T.PARENT_ULTIMATE_DUNS_NUMBER = S.PARENT_ULTIMATE_DUNS_NUMBER,
    T.PARENT_BEST_SUPPLIER_ID = S.PARENT_BEST_SUPPLIER_ID,
    T.SUPPLIER_NAME = S.SUPPLIER_NAME,
    T.BUSINESS_UNIT = S.BUSINESS_UNIT,
    T.ESATS_BA_MAX_AEC = S.ESATS_BA_MAX_AEC,
    T.ESATS_BA_MAX_AEC_NAME = S.ESATS_BA_MAX_AEC_NAME,
    T.BART_HAS_REVERSE_PROXY = S.BART_HAS_REVERSE_PROXY,
    T.BART_HAS_SECURE_TOKEN = S.BART_HAS_SECURE_TOKEN,
    T.BART_BA_USER_COUNT = S.BART_BA_USER_COUNT,
    T.CAIRO_HIGHEST_LEVEL_CONFIDENTIALITY_CONTROL_CODE = S.CAIRO_HIGHEST_LEVEL_CONFIDENTIALITY_CONTROL_CODE,
    T.CAIRO_DISTINCT_INFORMATION_TYPE = S.CAIRO_DISTINCT_INFORMATION_TYPE,
    T.BEDW_SP1_REPS_AND_CERTS = S.BEDW_SP1_REPS_AND_CERTS,
    T.BEDW_ATBEZ_VALUES = S.BEDW_ATBEZ_VALUES,
    T.ESAFE_SECURE_BADGE_COUNT = S.ESAFE_SECURE_BADGE_COUNT,
    T.ESAFE_SECURE_ACCESS_BADGE_COUNT = S.ESAFE_SECURE_ACCESS_BADGE_COUNT,
    T.ESAFE_BADGE_TYPE_VALUES = S.ESAFE_BADGE_TYPE_VALUES,
    T.SCRS_SUPPLIER_CRITICALITY_PRIORITY = S.SCRS_SUPPLIER_CRITICALITY_PRIORITY,
    T.Commodity = S.Commodity,
    -- If you keep the alias in SOURCE_DATA:
    T.COMMODITY_CODES_DESC = S.Commodity_Desc,
    T.Contracts_PAs = S.Contracts_PAs,
    T.Sum_of_SW_HW = S.Sum_of_SW_HW,
    T.Sum_of_SW_Dev = S.Sum_of_SW_Dev,
    T.SOFTWARE_HARDWARE_RISK_SCORE = S.SOFTWARE_HARDWARE_RISK_SCORE,
    T.ACCESS_MANAGEMENT_RISK_SCORE = S.ACCESS_MANAGEMENT_RISK_SCORE,
    T.DATA_MANAGEMENT_RISK_SCORE = S.DATA_MANAGEMENT_RISK_SCORE,
    T.CYBER_COMPLIANCE_RISK_SCORE = S.CYBER_COMPLIANCE_RISK_SCORE,
    T.PHYSICAL_SECURITY_RISK_SCORE = S.PHYSICAL_SECURITY_RISK_SCORE,
    T.BUSINESS_RESILIENCE_RISK_SCORE = S.BUSINESS_RESILIENCE_RISK_SCORE,
    T.INHERENT_RISK_RATING_LOOKBACK_SCORE = S.INHERENT_RISK_RATING_LOOKBACK_SCORE,
    T.IRR = S.IRR,
    T.DATA_HASH = S.DATA_HASH,
    T.updated_at = CURRENT_TIMESTAMP(),
    T.updated_by = 'airflow DAG',
    T.load_run_id = 'run_2025_11_05'

WHEN NOT MATCHED THEN
  INSERT (
    SUPPLIER_BEST_CODE,
    DUNSNUMBER,
    GLOBAL_ULTIMATE_DUNS_NUMBER,
    PARENT_ULTIMATE_DUNS_NUMBER,
    PARENT_BEST_SUPPLIER_ID,
    SUPPLIER_NAME,
    BUSINESS_UNIT,
    ESATS_BA_MAX_AEC,
    ESATS_BA_MAX_AEC_NAME,
    BART_HAS_REVERSE_PROXY,
    BART_HAS_SECURE_TOKEN,
    BART_BA_USER_COUNT,
    CAIRO_HIGHEST_LEVEL_CONFIDENTIALITY_CONTROL_CODE,
    CAIRO_DISTINCT_INFORMATION_TYPE,
    BEDW_SP1_REPS_AND_CERTS,
    BEDW_ATBEZ_VALUES,
    ESAFE_SECURE_BADGE_COUNT,
    ESAFE_SECURE_ACCESS_BADGE_COUNT,
    ESAFE_BADGE_TYPE_VALUES,
    SCRS_SUPPLIER_CRITICALITY_PRIORITY,
    Commodity,
    COMMODITY_CODES_DESC,
    Contracts_PAs,
    Sum_of_SW_HW,
    Sum_of_SW_Dev,
    SOFTWARE_HARDWARE_RISK_SCORE,
    ACCESS_MANAGEMENT_RISK_SCORE,
    DATA_MANAGEMENT_RISK_SCORE,
    CYBER_COMPLIANCE_RISK_SCORE,
    PHYSICAL_SECURITY_RISK_SCORE,
    BUSINESS_RESILIENCE_RISK_SCORE,
    INHERENT_RISK_RATING_LOOKBACK_SCORE,
    IRR,
    EVENT_TIMESTAMP,
    PROCESS_TIMESTAMP,
    EVENT_COMMIT_NUMBER,
    TRANSACTION_TYPE,
    REPLICATION_ID,
    data_hash,
    created_at,
    updated_at,
    load_run_id,
    is_deleted
  )
  VALUES (
    S.SUPPLIER_BEST_CODE,
    S.DUNSNUMBER,
    S.GLOBAL_ULTIMATE_DUNS_NUMBER,
    S.PARENT_ULTIMATE_DUNS_NUMBER,
    S.PARENT_BEST_SUPPLIER_ID,
    S.SUPPLIER_NAME,
    S.BUSINESS_UNIT,
    S.ESATS_BA_MAX_AEC,
    S.ESATS_BA_MAX_AEC_NAME,
    S.BART_HAS_REVERSE_PROXY,
    S.BART_HAS_SECURE_TOKEN,
    S.BART_BA_USER_COUNT,
    S.CAIRO_HIGHEST_LEVEL_CONFIDENTIALITY_CONTROL_CODE,
    S.CAIRO_DISTINCT_INFORMATION_TYPE,
    S.BEDW_SP1_REPS_AND_CERTS,
    S.BEDW_ATBEZ_VALUES,
    S.ESAFE_SECURE_BADGE_COUNT,
    S.ESAFE_SECURE_ACCESS_BADGE_COUNT,
    S.ESAFE_BADGE_TYPE_VALUES,
    S.SCRS_SUPPLIER_CRITICALITY_PRIORITY,
    S.Commodity,
    S.Commodity_Desc,  -- if you keep the alias
    S.Contracts_PAs,
    S.Sum_of_SW_HW,
    S.Sum_of_SW_Dev,
    S.SOFTWARE_HARDWARE_RISK_SCORE,
    S.ACCESS_MANAGEMENT_RISK_SCORE,
    S.DATA_MANAGEMENT_RISK_SCORE,
    S.CYBER_COMPLIANCE_RISK_SCORE,
    S.PHYSICAL_SECURITY_RISK_SCORE,
    S.BUSINESS_RESILIENCE_RISK_SCORE,
    S.INHERENT_RISK_RATING_LOOKBACK_SCORE,
    S.IRR,
    S.EVENT_TIMESTAMP,
    S.PROCESS_TIMESTAMP,
    S.EVENT_COMMIT_NUMBER,
    S.TRANSACTION_TYPE,
    S.REPLICATION_ID,
    S.data_hash,
    CURRENT_TIMESTAMP(),
    CURRENT_TIMESTAMP(),
    'run_2025_11_05',
    FALSE
  );
